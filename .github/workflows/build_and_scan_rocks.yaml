name: Build and scan ROCKs, save and send scan reports

on:
  schedule:
  # every day at 1:12AM UTC
  - cron: '12 1 * * *'
    secrets:
      CVE_REPORT_JIRA_URL:
        required: true

jobs:
  build-scan-rocks:
    name: Build and scan ROCKs
    runs-on: [self-hosted, linux, X64, jammy, two-xlarge]
    timeout-minutes: 200
    strategy:
      matrix:
        rock:
          - mlserver-huggingface
          - mlserver-mlflow
          - mlserver-sklearn
          - mlserver-xgboost
          - seldon-core-operator
          - sklearnserver
          - tensorflow-serving
    steps:
      - name: Install tools
        run: |
          sudo apt-get update -yqq
          sudo apt install software-properties-common -yqq
          sudo apt-get install -yqq python3-pip
          sudo --preserve-env=http_proxy,https_proxy,no_proxy pip3 install tox pip-tools

      - name: Install ROCK dev tools
        run: |
          sudo install rockcraft --classic --edge

      - name: Setup LXD
        run: |
          sudo lxd waitready || true
          sudo lxd init --minimal
          sudo chmod a+wr /var/snap/lxd/common/lxd/unix.socket
          lxc network set lxdbr0 ipv6.address none
          bash -c 'sudo usermod -a -G lxd $USER'
          bash -c 'sudo su $USER'

      - name: Build and scan ROCK
      - uses: canonical/charmed-kubeflow-workflows/.github/workflows/build_and_scan_rock.yaml@main
        secrets:
          JIRA_URL: ${{ secrets.CVE_REPORT_JIRA_URL }}
        with:
          rock: ${{ matrix.rock }}
